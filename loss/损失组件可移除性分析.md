# æŸå¤±ç»„ä»¶å¯ç§»é™¤æ€§åˆ†æ

## åˆ†æç»“æœ

æ ¹æ®ä»£ç æ£€æŸ¥ï¼Œä»¥ä¸‹æ˜¯å„æŸå¤±ç»„ä»¶çš„ä½¿ç”¨æƒ…å†µå’Œç§»é™¤éš¾åº¦ï¼š

### âœ… **æœ€å®¹æ˜“å»æ‰ï¼ˆæœªå®é™…ä½¿ç”¨ï¼‰**

#### 1. **feature_diversity_loss** â­â­â­â­â­
- **çŠ¶æ€**: åœ¨æ¨¡å‹ä¸­å®šä¹‰ä½†**æœªåœ¨train_stepä¸­ä½¿ç”¨**
- **ä½ç½®**: `models/Resnet1D.py` å’Œ `models/Resnet1D_nocontrast.py` ä¸­å®šä¹‰ä½†æœªè°ƒç”¨
- **ç§»é™¤éš¾åº¦**: â­ éå¸¸å®¹æ˜“
- **å½±å“**: æ— å½±å“ï¼ˆå½“å‰æœªä½¿ç”¨ï¼‰
- **æ“ä½œ**: ç›´æ¥åˆ é™¤ç›¸å…³ä»£ç å³å¯

#### 2. **HardNegativeMining (HNM)** â­â­â­â­â­
- **çŠ¶æ€**: åœ¨æ¨¡å‹ä¸­å®šä¹‰ï¼Œä½†**æœªåœ¨train_stepä¸­ä½¿ç”¨**
- **ä½ç½®**: åªåœ¨ `on_eval_end()` ä¸­è°ƒç”¨ `apply_epoch_momentum()`ï¼Œä½†å®é™…æŸå¤±è®¡ç®—æœªä½¿ç”¨
- **ç§»é™¤éš¾åº¦**: â­ éå¸¸å®¹æ˜“
- **å½±å“**: æ— å½±å“ï¼ˆå½“å‰æœªä½¿ç”¨ï¼‰
- **æ“ä½œ**: åˆ é™¤ `self.expert_hnm` å’Œç›¸å…³å¯¼å…¥

### âš ï¸ **è¾ƒå®¹æ˜“å»æ‰ï¼ˆè¾…åŠ©æ€§æŸå¤±ï¼‰**

#### 3. **CenterRegularizationLoss (L_reg)** â­â­â­â­
- **çŠ¶æ€**: åœ¨æŸå¤±åŒ…è£…å™¨ä¸­ä½¿ç”¨ï¼Œä½†æƒé‡å¾ˆä½ï¼ˆ0.001ï¼‰
- **ä½œç”¨**: é˜²æ­¢å°¾éƒ¨ç±»ç‰¹å¾ä¸­å¿ƒæ¼‚ç§»
- **ç§»é™¤éš¾åº¦**: â­â­ å®¹æ˜“
- **å½±å“**: 
  - å¯èƒ½è½»å¾®å½±å“å°¾éƒ¨ç±»æ€§èƒ½
  - ä½†æƒé‡å·²ç»å¾ˆä½ï¼Œå½±å“åº”è¯¥å¾ˆå°
- **æ“ä½œ**: åœ¨æŸå¤±åŒ…è£…å™¨ä¸­åˆ é™¤æˆ–è®¾ç½®æƒé‡ä¸º0

#### 4. **ICLMoELoss ä¸­çš„ L_col (åä½œå­¦ä¹ æŸå¤±)** â­â­â­
- **çŠ¶æ€**: åœ¨ICLMoELossä¸­ä½¿ç”¨
- **ä½œç”¨**: è®©ä¸“å®¶å‘é›†æˆè¾“å‡ºçœ‹é½ï¼ˆçŸ¥è¯†è’¸é¦ï¼‰
- **ç§»é™¤éš¾åº¦**: â­â­â­ ä¸­ç­‰
- **å½±å“**: 
  - å¯èƒ½é™ä½ä¸“å®¶é—´çš„ä¸€è‡´æ€§
  - ä½†DoLï¼ˆç‹¬ç«‹ä¼˜åŒ–æŸå¤±ï¼‰ä»ç„¶ä¿ç•™ï¼Œå½±å“å¯æ§
- **æ“ä½œ**: ä¿®æ”¹ICLMoELossï¼Œåªè¿”å›L_dol

#### 5. **HierarchicalLoss ä¸­çš„ L_sg (ç©ºé—´ç¾¤æŸå¤±)** â­â­â­
- **çŠ¶æ€**: åœ¨HierarchicalLossä¸­ä½¿ç”¨
- **ä½œç”¨**: ç©ºé—´ç¾¤çº§åˆ«çš„åˆ†ç±»æŸå¤±ï¼ˆå¸¦æ©ç ï¼‰
- **ç§»é™¤éš¾åº¦**: â­â­â­ ä¸­ç­‰
- **å½±å“**: 
  - åªä¿ç•™æ™¶ç³»åˆ†ç±»æŸå¤±ï¼ˆL_sysï¼‰
  - å¤±å»å±‚çº§åŒ–çº¦æŸï¼Œä½†æ™¶ç³»åˆ†ç±»ä»ç„¶æœ‰æ•ˆ
- **æ“ä½œ**: ä¿®æ”¹HierarchicalLossï¼Œåªè¿”å›L_sys

### ğŸ”´ **ä¸å»ºè®®å»æ‰ï¼ˆæ ¸å¿ƒæŸå¤±ï¼‰**

#### 6. **ICLMoELoss ä¸­çš„ L_dol (ç‹¬ç«‹ä¼˜åŒ–æŸå¤±)** â­
- **çŠ¶æ€**: MoEçš„æ ¸å¿ƒæŸå¤±
- **ä½œç”¨**: å¼ºåˆ¶æ¯ä¸ªä¸“å®¶ç‹¬ç«‹åˆ†ç±»
- **ç§»é™¤éš¾åº¦**: â­â­â­â­â­ éå¸¸å›°éš¾
- **å½±å“**: å»æ‰åMoEå¤±å»æ„ä¹‰
- **å»ºè®®**: **å¿…é¡»ä¿ç•™**

#### 7. **HierarchicalLoss ä¸­çš„ L_sys (æ™¶ç³»æŸå¤±)** â­â­
- **çŠ¶æ€**: å±‚çº§åŒ–åˆ†ç±»çš„æ ¸å¿ƒ
- **ä½œç”¨**: æ™¶ç³»çº§åˆ«çš„åˆ†ç±»
- **ç§»é™¤éš¾åº¦**: â­â­â­â­ å›°éš¾
- **å½±å“**: å¤±å»å±‚çº§åŒ–è®¾è®¡ï¼Œé—¨æ§ç½‘ç»œå¤±å»æ™¶ç³»ä¿¡æ¯
- **å»ºè®®**: **å»ºè®®ä¿ç•™**

#### 8. **PhysicsContrastiveLoss** â­â­
- **çŠ¶æ€**: å·²æœ‰NoContrastç‰ˆæœ¬
- **ä½œç”¨**: å¯¹æ¯”å­¦ä¹ 
- **ç§»é™¤éš¾åº¦**: â­ å®¹æ˜“ï¼ˆå·²æœ‰ç‰ˆæœ¬ï¼‰
- **å½±å“**: æ— ï¼ˆä½¿ç”¨NoContrastç‰ˆæœ¬å³å¯ï¼‰
- **å»ºè®®**: å·²é€šè¿‡NoContrastç‰ˆæœ¬å®ç°

## æ¨èç§»é™¤æ–¹æ¡ˆ

### æ–¹æ¡ˆ1: æœ€å°åŒ–ç‰ˆæœ¬ï¼ˆç§»é™¤æ‰€æœ‰æœªä½¿ç”¨çš„ï¼‰

**ç§»é™¤**:
1. âœ… `feature_diversity_loss` - æœªä½¿ç”¨
2. âœ… `HardNegativeMining` - æœªä½¿ç”¨

**ä¿ç•™**:
- ICLMoELoss (L_dol + L_col)
- HierarchicalLoss (L_sys + L_sg)
- CenterRegularizationLoss (æƒé‡å·²å¾ˆä½)

**æ€»æŸå¤±**:
```
L = L_dol + L_col + L_sys + L_sg + 0.001 * L_reg
```

### æ–¹æ¡ˆ2: ç®€åŒ–ç‰ˆæœ¬ï¼ˆç§»é™¤è¾…åŠ©æŸå¤±ï¼‰

**ç§»é™¤**:
1. âœ… `feature_diversity_loss`
2. âœ… `HardNegativeMining`
3. âœ… `CenterRegularizationLoss` (L_reg)
4. âš ï¸ `ICLMoELoss` ä¸­çš„ `L_col` (åä½œå­¦ä¹ )

**ä¿ç•™**:
- ICLMoELoss ä¸­çš„ L_dol (ç‹¬ç«‹ä¼˜åŒ–)
- HierarchicalLoss (L_sys + L_sg)

**æ€»æŸå¤±**:
```
L = L_dol + L_sys + L_sg
```

### æ–¹æ¡ˆ3: æç®€ç‰ˆæœ¬ï¼ˆåªä¿ç•™æ ¸å¿ƒï¼‰

**ç§»é™¤**:
1. âœ… `feature_diversity_loss`
2. âœ… `HardNegativeMining`
3. âœ… `CenterRegularizationLoss`
4. âš ï¸ `ICLMoELoss` ä¸­çš„ `L_col`
5. âš ï¸ `HierarchicalLoss` ä¸­çš„ `L_sg`

**ä¿ç•™**:
- ICLMoELoss ä¸­çš„ L_dol
- HierarchicalLoss ä¸­çš„ L_sys

**æ€»æŸå¤±**:
```
L = L_dol + L_sys
```

## å…·ä½“å®ç°å»ºè®®

### ä¼˜å…ˆçº§æ’åºï¼ˆä»æ˜“åˆ°éš¾ï¼‰

1. **ç¬¬ä¸€ä¼˜å…ˆçº§ï¼ˆç«‹å³ç§»é™¤ï¼‰**:
   - `feature_diversity_loss` - å®Œå…¨æœªä½¿ç”¨
   - `HardNegativeMining` - å®Œå…¨æœªä½¿ç”¨

2. **ç¬¬äºŒä¼˜å…ˆçº§ï¼ˆå¯è€ƒè™‘ç§»é™¤ï¼‰**:
   - `CenterRegularizationLoss` - æƒé‡å¾ˆä½ï¼Œå½±å“å°
   - `ICLMoELoss` ä¸­çš„ `L_col` - è¾…åŠ©æ€§ï¼ŒDoLå·²è¶³å¤Ÿ

3. **ç¬¬ä¸‰ä¼˜å…ˆçº§ï¼ˆè°¨æ…ç§»é™¤ï¼‰**:
   - `HierarchicalLoss` ä¸­çš„ `L_sg` - å±‚çº§åŒ–çš„æ ¸å¿ƒéƒ¨åˆ†
   - `ICLMoELoss` ä¸­çš„ `L_dol` - **ä¸å»ºè®®ç§»é™¤**

## ä»£ç ä¿®æ”¹ä½ç½®

### ç§»é™¤ feature_diversity_loss

**æ–‡ä»¶**: `models/Resnet1D.py`, `models/Resnet1D_nocontrast.py`
```python
# åˆ é™¤
self.diversity_loss = feature_diversity_loss
```

### ç§»é™¤ HardNegativeMining

**æ–‡ä»¶**: `models/Resnet1D.py`, `models/Resnet1D_nocontrast.py`
```python
# åˆ é™¤å¯¼å…¥
from loss.HNM import HardNegativeMining_Proto as HardNegativeMining

# åˆ é™¤åˆå§‹åŒ–
self.expert_hnm = [...]

# åˆ é™¤on_eval_endä¸­çš„è°ƒç”¨
# for hnm in self.expert_hnm:
#     hnm.apply_epoch_momentum()
```

### ç§»é™¤ CenterRegularizationLoss

**æ–‡ä»¶**: `loss/physics_contrast_loss.py`
```python
# åœ¨PhysMoELossWrapperå’ŒPhysMoELossWrapperNoContrastä¸­
# æ–¹æ³•1: è®¾ç½®æƒé‡ä¸º0
self.lambda_reg = 0.0

# æ–¹æ³•2: åˆ é™¤ç›¸å…³ä»£ç 
# self.center_reg = ...
# l_reg = ...
```

### ç§»é™¤ L_col (åä½œå­¦ä¹ æŸå¤±)

**æ–‡ä»¶**: `loss/physics_contrast_loss.py`
```python
# ä¿®æ”¹ICLMoELoss.forwardï¼Œåªè¿”å›L_dol
def forward(self, expert_logits_list, gating_weights, labels):
    loss_dol = 0.0
    for k, logits in enumerate(expert_logits_list):
        if k in self.tail_expert_ids:
            loss_dol += self.focal_loss(logits, labels)
        else:
            loss_dol += F.cross_entropy(logits, labels)
    
    # åˆ é™¤L_colè®¡ç®—
    # loss_col = ...
    
    # è®¡ç®—ensemble_logitsç”¨äºå…¶ä»–æŸå¤±
    stacked_logits = torch.stack(expert_logits_list, dim=1)
    ensemble_logits = torch.einsum('be,bec->bc', gating_weights, stacked_logits)
    
    return loss_dol, 0.0, ensemble_logits  # è¿”å›0ä½œä¸ºL_col
```

### ç§»é™¤ L_sg (ç©ºé—´ç¾¤æŸå¤±)

**æ–‡ä»¶**: `loss/physics_contrast_loss.py`
```python
# ä¿®æ”¹HierarchicalLoss.forward
def forward(self, sys_logits, sg_logits, labels):
    sys_labels = self.sg_to_sys_map[labels]
    loss_sys = F.cross_entropy(sys_logits, sys_labels)
    
    # åˆ é™¤L_sgè®¡ç®—
    # loss_sg = ...
    
    return loss_sys, 0.0  # è¿”å›0ä½œä¸ºL_sg
```

## æ€»ç»“

**æœ€å®¹æ˜“å»æ‰çš„æŸå¤±ç»„ä»¶**ï¼ˆæŒ‰ä¼˜å…ˆçº§ï¼‰:

1. â­â­â­â­â­ **feature_diversity_loss** - å®Œå…¨æœªä½¿ç”¨ï¼Œé›¶å½±å“
2. â­â­â­â­â­ **HardNegativeMining** - å®Œå…¨æœªä½¿ç”¨ï¼Œé›¶å½±å“
3. â­â­â­â­ **CenterRegularizationLoss** - æƒé‡å¾ˆä½ï¼Œå½±å“å°
4. â­â­â­ **L_col (åä½œå­¦ä¹ )** - è¾…åŠ©æ€§ï¼ŒDoLå·²è¶³å¤Ÿ
5. â­â­â­ **L_sg (ç©ºé—´ç¾¤æŸå¤±)** - å¯ç®€åŒ–ï¼Œä½†ä¼šå¤±å»å±‚çº§åŒ–çº¦æŸ

**å»ºè®®**: å…ˆä»æ–¹æ¡ˆ1å¼€å§‹ï¼ˆç§»é™¤æœªä½¿ç”¨çš„ï¼‰ï¼Œç„¶åæ ¹æ®è®­ç»ƒæ•ˆæœå†³å®šæ˜¯å¦è¿›ä¸€æ­¥ç®€åŒ–ã€‚
