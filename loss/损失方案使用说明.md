# 损失方案使用说明

## 概述

现在支持通过 `train.py` 的参数选择不同的损失函数方案，包括方案2和方案3的简化版本。

## 可用方案

### 默认方案（完整版本）
- **损失组成**: `L_dol + L_col + L_sys + L_sg + L_reg + L_scl`
- **特点**: 包含所有损失组件（包括对比学习）

### NoContrast方案（无对比学习）
- **损失组成**: `L_dol + L_col + L_sys + L_sg + L_reg`
- **特点**: 移除对比学习损失

### Scheme2方案（简化版本1）
- **损失组成**: `L_dol + L_sys + L_sg`
- **移除**: `L_reg` (中心正则化), `L_col` (协作学习)
- **保留**: `L_dol` (独立优化), `L_sys` (晶系损失), `L_sg` (空间群损失)

### Scheme3方案（极简版本）
- **损失组成**: `L_dol + L_sys`
- **移除**: `L_reg` (中心正则化), `L_col` (协作学习), `L_sg` (空间群损失)
- **保留**: `L_dol` (独立优化), `L_sys` (晶系损失)

## 使用方法

### 命令行参数

```bash
python train.py \
    --data_path /path/to/data \
    --rule_matrix_path /path/to/rule_matrix.csv \
    --loss_scheme [default|scheme2|scheme3] \
    [--use_nocontrast]
```

### 参数说明

- `--loss_scheme`: 选择损失方案
  - `default`: 使用默认方案（完整版本或nocontrast，取决于是否使用`--use_nocontrast`）
  - `scheme2`: 使用方案2（移除L_reg和L_col）
  - `scheme3`: 使用方案3（移除L_reg、L_col和L_sg）

- `--use_nocontrast`: 是否使用无对比学习版本
  - 如果设置，默认使用 `PhysMoELossWrapperNoContrast`
  - 如果同时设置 `--loss_scheme scheme2` 或 `scheme3`，会使用对应的简化版本

### 使用示例

#### 示例1: 使用方案2（简化版本1）

```bash
python train.py \
    --data_path /opt/data/private/mp20/mp20_train \
    --rule_matrix_path /opt/data/private/ICL/rule_matrix.csv \
    --loss_scheme scheme2
```

**损失组成**: `L = L_dol + L_sys + L_sg`

#### 示例2: 使用方案3（极简版本）

```bash
python train.py \
    --data_path /opt/data/private/mp20/mp20_train \
    --rule_matrix_path /opt/data/private/ICL/rule_matrix.csv \
    --loss_scheme scheme3
```

**损失组成**: `L = L_dol + L_sys`

#### 示例3: 使用无对比学习版本 + 方案2

```bash
python train.py \
    --data_path /opt/data/private/mp20/mp20_train \
    --rule_matrix_path /opt/data/private/ICL/rule_matrix.csv \
    --use_nocontrast \
    --loss_scheme scheme2
```

**损失组成**: `L = L_dol + L_sys + L_sg`（无对比学习）

#### 示例4: 使用默认完整版本

```bash
python train.py \
    --data_path /opt/data/private/mp20/mp20_train \
    --rule_matrix_path /opt/data/private/ICL/rule_matrix.csv
```

**损失组成**: `L = L_dol + L_col + L_sys + L_sg + L_reg + L_scl`

## 方案对比

| 方案 | L_dol | L_col | L_sys | L_sg | L_reg | L_scl | 总损失项数 |
|------|-------|-------|-------|------|-------|-------|-----------|
| 完整版 | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ | 6 |
| NoContrast | ✅ | ✅ | ✅ | ✅ | ✅ | ❌ | 5 |
| Scheme2 | ✅ | ❌ | ✅ | ✅ | ❌ | ❌ | 3 |
| Scheme3 | ✅ | ❌ | ✅ | ❌ | ❌ | ❌ | 2 |

## 各损失组件说明

### L_dol (独立优化损失)
- **作用**: 强制每个专家独立进行分类
- **重要性**: ⭐⭐⭐⭐⭐ 核心损失，必须保留
- **移除影响**: MoE失去意义

### L_col (协作学习损失)
- **作用**: 让专家向集成输出看齐（知识蒸馏）
- **重要性**: ⭐⭐⭐ 辅助性，可移除
- **移除影响**: 可能降低专家间一致性，但DoL仍保留

### L_sys (晶系损失)
- **作用**: 晶系级别的分类损失
- **重要性**: ⭐⭐⭐⭐ 层级化核心，建议保留
- **移除影响**: 失去层级化设计，门控网络失去晶系信息

### L_sg (空间群损失)
- **作用**: 空间群级别的分类损失（带掩码）
- **重要性**: ⭐⭐⭐ 层级化的一部分，可移除
- **移除影响**: 失去层级化约束，但晶系分类仍有效

### L_reg (中心正则化)
- **作用**: 防止尾部类特征中心漂移
- **重要性**: ⭐⭐ 辅助性，权重已很低(0.001)
- **移除影响**: 可能轻微影响尾部类，但影响很小

### L_scl (对比学习损失)
- **作用**: 物理规则加权的对比学习
- **重要性**: ⭐⭐ 可选，已有NoContrast版本
- **移除影响**: 无（使用NoContrast版本即可）

## 推荐使用场景

### 方案2 (Scheme2)
- **适用场景**: 
  - 想要简化损失但保留层级化约束
  - 训练速度优先
  - 对尾部类性能要求不是特别高

### 方案3 (Scheme3)
- **适用场景**:
  - 追求最简单的损失函数
  - 快速实验和调试
  - 只关注核心的MoE和晶系分类

## 代码修改说明

### 已移除的未使用组件

1. **feature_diversity_loss**: 在模型中定义但未使用，已注释
2. **HardNegativeMining (HNM)**: 在模型中定义但未使用，已注释

### 新增的损失包装器

1. **PhysMoELossWrapperScheme2**: 方案2的损失包装器
2. **PhysMoELossWrapperScheme3**: 方案3的损失包装器

### 修改的基础类

1. **ICLMoELoss**: 添加 `use_col` 参数控制是否使用L_col
2. **HierarchicalLoss**: 添加 `use_sg` 参数控制是否使用L_sg

## 注意事项

1. **模型兼容性**: 所有方案都使用相同的模型架构，只是损失函数不同
2. **参数传递**: `loss_scheme` 参数通过 `args.model.loss_scheme` 传递到模型
3. **默认行为**: 
   - 如果使用 `--use_nocontrast`，默认 `loss_scheme='nocontrast'`
   - 如果不使用 `--use_nocontrast`，默认 `loss_scheme='full'`
   - 如果指定 `--loss_scheme scheme2` 或 `scheme3`，会覆盖默认值

## 验证

运行以下命令验证各方案是否正常工作：

```bash
# 测试方案2
python train.py --data_path /path/to/data --rule_matrix_path /path/to/rule_matrix.csv --loss_scheme scheme2 --device 0

# 测试方案3
python train.py --data_path /path/to/data --rule_matrix_path /path/to/rule_matrix.csv --loss_scheme scheme3 --device 0
```

如果训练正常开始且损失值合理，说明配置成功。
